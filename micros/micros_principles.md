
# Домашнее задание к занятию «Микросервисы: принципы»

Вы работаете в крупной компании, которая строит систему на основе микросервисной архитектуры.
Вам как DevOps-специалисту необходимо выдвинуть предложение по организации инфраструктуры для разработки и эксплуатации.

## Задача 1: API Gateway 

Предложите решение для обеспечения реализации API Gateway. Составьте сравнительную таблицу возможностей различных программных решений. На основе таблицы сделайте выбор решения.

Решение должно соответствовать следующим требованиям:
- маршрутизация запросов к нужному сервису на основе конфигурации,
- возможность проверки аутентификационной информации в запросах,
- обеспечение терминации HTTPS.

Обоснуйте свой выбор.

## Сравнительная таблица

| Feature                             | Kong               | NGINX               | Amazon API Gateway   | Apigee              |
|-------------------------------------|--------------------|---------------------|----------------------|---------------------|
| Маршрутизация запросов          | Да                 | Да                  | Да                   | Да                  |
| Проверка аутентификационной информации | Да (плагины)       | Да (модули)         | Да                   | Да                  |
| Обеспечение терминации HTTPS    | Да                 | Да                  | Да                   | Да                  |
| Легкость конфигурации           | Высокая            | Средняя             | Высокая              | Средняя             |
| Интеграция с внешними системами | Высокая            | Средняя             | Высокая              | Высокая             |
| Плагины и расширения            | Широкий выбор      | Ограниченный выбор  | Ограниченный выбор   | Широкий выбор       |
| Поддержка масштабируемости      | Высокая            | Высокая             | Высокая              | Высокая             |
| Стоимость                       | Открытый исходный код (бесплатный, платные дополнения) | Открытый исходный код (бесплатный, платные дополнения) | Платное, по модели pay-as-you-go | Платное, зависит от использования |
| Документация и поддержка        | Отличная           | Хорошая             | Отличная             | Отличная            |
| Логирование и мониторинг        | Да                 | Да                  | Да                   | Да                  |
| Сообщество пользователей        | Большое            | Большое             | Среднее              | Большое             |

## Анализ и выбор

1. Kong:
   - Маршрутизация запросов: Обеспечивается гибкая маршрутизация на основе конфигурации.
   - Проверка аутентификационной информации: Поддерживается большое количество плагинов для аутентификации.
   - Обеспечение терминации HTTPS: Поддерживается.
   - Легкость конфигурации: Высокая, благодаря удобным инструментам управления.
   - Расширяемость: Высокая, благодаря широкому выбору плагинов.
   - Стоимость: Бесплатно в основной версии с открытым исходным кодом, платные дополнения доступны.
   - Документация и поддержка: Отличная, много обучающих материалов и активное сообщество.

2. NGINX:
   - Маршрутизация запросов: Обеспечивается гибкая маршрутизация на основе конфигурационных файлов.
   - Проверка аутентификационной информации: Поддерживается с помощью модулей.
   - Обеспечение терминации HTTPS: Поддерживается.
   - Легкость конфигурации: Средняя, требует знаний конфигурационных файлов NGINX.
   - Расширяемость: Ограниченная, меньшее количество готовых модулей по сравнению с Kong.
   - Стоимость: Бесплатно в основной версии с открытым исходным кодом, платные дополнения и коммерческая поддержка доступны.
   - Документация и поддержка: Хорошая, но менее удобная для начинающих.

3. Amazon API Gateway:
   - Маршрутизация запросов: Поддерживается, интеграция с AWS Lambda и другими сервисами AWS.
   - Проверка аутентификационной информации: Поддерживается, включая интеграцию с AWS IAM, Cognito и другими.
   - Обеспечение терминации HTTPS: Поддерживается.
   - Легкость конфигурации: Высокая, благодаря интеграции с AWS Console.
   - Расширяемость: Ограниченная, так как завязана на экосистему AWS.
   - Стоимость: Платное, по модели pay-as-you-go.
   - Документация и поддержка: Отличная, с хорошей интеграцией в экосистему AWS.

4. Apigee:
   - Маршрутизация запросов: Обеспечивается гибкая маршрутизация на основе конфигурации.
   - Проверка аутентификационной информации: Поддерживается с помощью мощных инструментов аутентификации и авторизации.
   - Обеспечение терминации HTTPS: Поддерживается.
   - Легкость конфигурации: Средняя, требует изучения специфичных инструментов Apigee.
   - Расширяемость: Высокая, множество встроенных возможностей и интеграций.
   - Стоимость: Платное, зависит от использования.
   - Документация и поддержка: Отличная, большое количество обучающих материалов и активное сообщество.

## Рекомендация

На основе вышеуказанного анализа, для реализации API Gateway, которая должна соответствовать требованиям маршрутизации запросов, проверки аутентификационной информации и терминации HTTPS, я рекомендую использовать Kong. Это решение обладает высокой гибкостью, широкими возможностями расширения благодаря плагинам, и имеет отличную документацию и сообщество. Кроме того, Kong предоставляет все необходимые функции бесплатно в своей версии с открытым исходным кодом, что делает его отличным выбором с точки зрения стоимости и функциональности.

## Задача 2: Брокер сообщений

Составьте таблицу возможностей различных брокеров сообщений. На основе таблицы сделайте обоснованный выбор решения.

Решение должно соответствовать следующим требованиям:
- поддержка кластеризации для обеспечения надёжности,
- хранение сообщений на диске в процессе доставки,
- высокая скорость работы,
- поддержка различных форматов сообщений,
- разделение прав доступа к различным потокам сообщений,
- простота эксплуатации.

Обоснуйте свой выбор.

Для выбора оптимального брокера сообщений, который удовлетворяет требованиям к поддержке кластеризации, хранению сообщений на диске, высокой скорости работы, поддержке различных форматов сообщений, разделению прав доступа и простоте эксплуатации, рассмотрим четыре популярных решения: Apache Kafka, RabbitMQ, ActiveMQ и NATS. 

### Сравнительная таблица

| Feature                               | Apache Kafka             | RabbitMQ                  | ActiveMQ                  | NATS                        |
|---------------------------------------|--------------------------|---------------------------|---------------------------|-----------------------------|
| Кластеризация                     | Да                       | Да                        | Да                        | Да                          |
| Хранение сообщений на диске       | Да                       | Да                        | Да                        | Частично (JetStream)        |
| Высокая скорость работы           | Очень высокая            | Высокая                   | Высокая                   | Очень высокая               |
| Поддержка различных форматов сообщений | Да (Avro, JSON, Protobuf) | Да (JSON, XML, Protobuf)  | Да (JSON, XML, Protobuf)  | Да (Protobuf, JSON)         |
| Разделение прав доступа           | Да (ACL)                 | Да (Vhosts, Permissions)  | Да (Authorization policies)| Ограничено (ACL)            |
| Простота эксплуатации             | Средняя                  | Высокая                   | Средняя                   | Высокая                     |
| Документация и поддержка          | Отличная                 | Отличная                  | Хорошая                   | Хорошая                     |
| Сообщество пользователей          | Большое                  | Большое                   | Среднее                   | Среднее                     |
| Преимущества                      | Высокая производительность и масштабируемость | Простота настройки и эксплуатации | Гибкость и надежность       | Минимальная задержка, простота |
| Недостатки                        | Сложность администрирования и настройки | Ограниченная масштабируемость | Меньшее сообщество, сложнее в настройке | Ограниченная функциональность в базовой версии |
| Используемый протокол             | Проприетарный (Kafka Protocol) | AMQP                      | OpenWire, STOMP, AMQP      | NATS Protocol               |

### Анализ и выбор

1. Apache Kafka:
   - Кластеризация: Поддерживается нативно, обеспечивая высокую доступность и надежность.
   - Хранение сообщений на диске: Поддерживается, с возможностью долгосрочного хранения.
   - Высокая скорость работы: Очень высокая, особенно для больших объемов данных.
   - Поддержка различных форматов сообщений: Поддерживает Avro, JSON, Protobuf и другие.
   - Разделение прав доступа: Поддерживает с помощью ACL.
   - Простота эксплуатации: Средняя, требует значительных усилий для настройки и администрирования.
   - Рекомендация: Отличный выбор для высоконагруженных систем с большими объемами данных, но может быть сложным в управлении.

2. RabbitMQ:
   - Кластеризация: Поддерживается, с возможностью настройки HA кластеров.
   - Хранение сообщений на диске: Поддерживается, с настройками для долговременного хранения.
   - Высокая скорость работы: Высокая, особенно для сообщений среднего объема.
   - Поддержка различных форматов сообщений: Поддерживает JSON, XML, Protobuf и другие.
   - Разделение прав доступа: Поддерживается через виртуальные хосты и разрешения.
   - Простота эксплуатации: Высокая, легкость настройки и эксплуатации.
   - Рекомендация: Хороший выбор для систем с умеренной нагрузкой, где важна простота управления.

3. ActiveMQ:
   - Кластеризация: Поддерживается, включая мастер-слейв и сетевые топологии.
   - Хранение сообщений на диске: Поддерживается, с высокой гибкостью в настройке.
   - Высокая скорость работы: Высокая, с хорошей поддержкой транзакций.
   - Поддержка различных форматов сообщений: Поддерживает JSON, XML, Protobuf и другие.
   - Разделение прав доступа: Поддерживается через политики авторизации.
   - Простота эксплуатации: Средняя, требует усилий для настройки и управления.
   - Рекомендация: Подходит для систем с высокими требованиями к надежности и гибкости.

4. NATS:
   - Кластеризация: Поддерживается, с минимальной задержкой.
   - Хранение сообщений на диске: Частично, с использованием JetStream.
   - Высокая скорость работы: Очень высокая, с минимальными задержками.
   - Поддержка различных форматов сообщений: Поддерживает Protobuf, JSON и другие.
   - Разделение прав доступа: Ограниченная поддержка ACL.
   - Простота эксплуатации: Высокая, очень простая настройка и использование.
   - Рекомендация: Отличный выбор для систем с требованиями к минимальным задержкам и высокой скорости.

### Рекомендация

На основе приведенного анализа и требований к системе, наиболее подходящим решением является RabbitMQ. Оно обеспечивает надежную кластеризацию, хранение сообщений на диске, высокую скорость работы, поддержку различных форматов сообщений и гибкое разделение прав доступа. Кроме того, RabbitMQ отличается простотой эксплуатации, что важно для обеспечения легкости управления и сопровождения системы.

## Задача 3: API Gateway * (необязательная)

### Есть три сервиса:

**minio**
- хранит загруженные файлы в бакете images,
- S3 протокол,

**uploader**
- принимает файл, если картинка сжимает и загружает его в minio,
- POST /v1/upload,

**security**
- регистрация пользователя POST /v1/user,
- получение информации о пользователе GET /v1/user,
- логин пользователя POST /v1/token,
- проверка токена GET /v1/token/validation.

### Необходимо воспользоваться любым балансировщиком и сделать API Gateway:

**POST /v1/register**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/user.

**POST /v1/token**
1. Анонимный доступ.
2. Запрос направляется в сервис security POST /v1/token.

**GET /v1/user**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис security GET /v1/user.

**POST /v1/upload**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис uploader POST /v1/upload.

**GET /v1/user/{image}**
1. Проверка токена. Токен ожидается в заголовке Authorization. Токен проверяется через вызов сервиса security GET /v1/token/validation/.
2. Запрос направляется в сервис minio GET /images/{image}.

### Ожидаемый результат

Результатом выполнения задачи должен быть docker compose файл, запустив который можно локально выполнить следующие команды с успешным результатом.
Предполагается, что для реализации API Gateway будет написан конфиг для NGinx или другого балансировщика нагрузки, который будет запущен как сервис через docker-compose и будет обеспечивать балансировку и проверку аутентификации входящих запросов.
Авторизация
curl -X POST -H 'Content-Type: application/json' -d '{"login":"bob", "password":"qwe123"}' http://localhost/token

**Загрузка файла**

curl -X POST -H 'Authorization: Bearer eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJzdWIiOiJib2IifQ.hiMVLmssoTsy1MqbmIoviDeFPvo-nCd92d4UFiN2O2I' -H 'Content-Type: octet/stream' --data-binary @yourfilename.jpg http://localhost/upload

**Получение файла**
curl -X GET http://localhost/images/4e6df220-295e-4231-82bc-45e4b1484430.jpg

---

#### [Дополнительные материалы: как запускать, как тестировать, как проверить](https://github.com/netology-code/devkub-homeworks/tree/main/11-microservices-02-principles)

---

### Как оформить ДЗ?

Выполненное домашнее задание пришлите ссылкой на .md-файл в вашем репозитории.

---
